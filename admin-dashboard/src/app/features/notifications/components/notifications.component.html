<div class="notifications-container">
  <!-- Header -->
  <div class="notifications-header">
    <h1>Notification Management</h1>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="createNotification()">
        <mat-icon>add</mat-icon>
        Create Notification
      </button>
      <button mat-stroked-button (click)="refreshData()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-cards" *ngIf="stats">
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon">
          <mat-icon>send</mat-icon>
        </div>
        <div class="stat-info">
          <h3>{{ stats.total_sent | number }}</h3>
          <p>Total Sent</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon">
          <mat-icon>check_circle</mat-icon>
        </div>
        <div class="stat-info">
          <h3>{{ stats.total_delivered | number }}</h3>
          <p>Delivered</p>
          <span class="delivery-rate">{{ stats.delivery_rate | number:'1.1-1' }}%</span>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon">
          <mat-icon>schedule</mat-icon>
        </div>
        <div class="stat-info">
          <h3>{{ stats.total_pending | number }}</h3>
          <p>Pending</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon">
          <mat-icon>error</mat-icon>
        </div>
        <div class="stat-info">
          <h3>{{ stats.total_failed | number }}</h3>
          <p>Failed</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Filters -->
  <mat-card class="filters-card">
    <form [formGroup]="filterForm" class="filters-form">
      <mat-form-field>
        <mat-label>Search</mat-label>
        <input matInput formControlName="search" placeholder="Search notifications...">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <mat-form-field>
        <mat-label>Type</mat-label>
        <mat-select formControlName="type">
          <mat-option value="">All Types</mat-option>
          <mat-option *ngFor="let type of notificationTypes" [value]="type.value">
            {{ type.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field>
        <mat-label>Read Status</mat-label>
        <mat-select formControlName="is_read">
          <mat-option value="">All</mat-option>
          <mat-option *ngFor="let status of readStatuses" [value]="status.value">
            {{ status.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-stroked-button type="button" (click)="clearFilters()">
        <mat-icon>clear</mat-icon>
        Clear
      </button>
    </form>
  </mat-card>

  <!-- Notifications Table -->
  <mat-card class="table-card">
    <div *ngIf="loading" class="loading-container">
      <mat-spinner></mat-spinner>
    </div>

    <div *ngIf="!loading">
      <table mat-table [dataSource]="notifications" class="notifications-table">
        <!-- Title Column -->
        <ng-container matColumnDef="title">
          <th mat-header-cell *matHeaderCellDef>Title</th>
          <td mat-cell *matCellDef="let notification">
            <div class="notification-title">
              <div class="title-with-icon">
                <mat-icon class="type-icon">{{ getTypeIcon(notification.type) }}</mat-icon>
                <strong>{{ notification.title }}</strong>
              </div>
              <p class="notification-body">{{ getMeetupInfo(notification) }}</p>
            </div>
          </td>
        </ng-container>

        <!-- Type Column -->
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef>Type</th>
          <td mat-cell *matCellDef="let notification">
            <mat-chip>{{ notification.type | titlecase }}</mat-chip>
          </td>
        </ng-container>

        <!-- Read Status Column -->
        <ng-container matColumnDef="is_read">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let notification">
            <mat-chip [color]="getReadStatusColor(notification.is_read)" class="read-status-chip">
              <mat-icon class="status-icon">{{ notification.is_read ? 'mark_email_read' : 'mark_email_unread' }}</mat-icon>
              {{ notification.is_read ? 'Read' : 'Unread' }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- User Info Column -->
        <ng-container matColumnDef="user_info">
          <th mat-header-cell *matHeaderCellDef>User</th>
          <td mat-cell *matCellDef="let notification">
            <div class="user-info">
              <span class="user-id">{{ notification.user_id?.substring(0, 8) || 'N/A' }}</span>
              <div *ngIf="notification.type === 'nearby_meetup'" class="meetup-details">
                <!-- <small>Distance: {{ (notification.data as any).distance_km | number:'1.2-2' }}km</small> -->
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Created At Column -->
        <ng-container matColumnDef="created_at">
          <th mat-header-cell *matHeaderCellDef>Created</th>
          <td mat-cell *matCellDef="let notification">
            <div class="date-info">
              <span class="date-primary">{{ notification.created_at | date:'MMM d, y' }}</span>
              <span class="date-secondary">{{ notification.created_at | date:'h:mm a' }}</span>
              <div *ngIf="notification.read_at" class="read-time">
                Read: {{ notification.read_at | date:'MMM d, h:mm a' }}
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let notification">
            <button mat-icon-button [matMenuTriggerFor]="actionMenu">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #actionMenu="matMenu">
              <!-- <button mat-menu-item (click)="toggleReadStatus(notification)">
                <mat-icon>{{ notification.is_read ? 'mark_email_unread' : 'mark_email_read' }}</mat-icon>
                Mark as {{ notification.is_read ? 'Unread' : 'Read' }}
              </button> -->
              <button mat-menu-item (click)="editNotification(notification)">
                <mat-icon>edit</mat-icon>
                Edit
              </button>
              <button mat-menu-item 
                      (click)="deleteNotification(notification)"
                      class="delete-action">
                <mat-icon>delete</mat-icon>
                Delete
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
            [class.unread-row]="!row.is_read"></tr>
      </table>

      <div *ngIf="notifications.length === 0" class="no-data">
        <mat-icon>notifications_none</mat-icon>
        <p>No notifications found</p>
      </div>
    </div>
  </mat-card>
</div>